import os
import json
import telebot
import logging
import time
from datetime import date, datetime
from random import choice
from apscheduler.schedulers.background import BackgroundScheduler
from apscheduler.triggers.cron import CronTrigger
from dotenv import load_dotenv

load_dotenv()
STICKERS = (
# –≤—Å—Ç–∞–≤–∏—Ç—å –∞–π–¥–∏ —Å—Ç–∏–∫–µ—Ä–æ–≤
)
BOT_TOKEN = os.getenv("BOT_TOKEN")
USER_ID = os.getenv("USER_ID")
ADMIN_USER_ID = os.getenv("ADMIN_USER_ID")
DEMILITARIZATION_DATE_STR = os.getenv("DEMILITARIZATION_DATE")

STATE_FILE = "sticker_state.json"
LOG_FILE = "user_logs.json"

def log_user_activity(user_id, username, command, message_text=""):
    """–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
    try:
        # –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ª–æ–≥–∏
        logs = []
        if os.path.exists(LOG_FILE):
            with open(LOG_FILE, "r", encoding="utf-8") as f:
                logs = json.load(f)
        
        # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å
        log_entry = {
            "timestamp": datetime.now().isoformat(),
            "user_id": str(user_id),
            "username": username or "Unknown",
            "command": command,
            "message": message_text[:100] if message_text else ""  # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É
        }
        logs.append(log_entry)
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—Ä–∞—Ç–Ω–æ (–æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 1000 –∑–∞–ø–∏—Å–µ–π)
        if len(logs) > 1000:
            logs = logs[-1000:]
        
        with open(LOG_FILE, "w", encoding="utf-8") as f:
            json.dump(logs, f, ensure_ascii=False, indent=2)
        
        # –í—ã–≤–æ–¥–∏–º –≤ –∫–æ–Ω—Å–æ–ª—å
        logging.info(f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {username or 'Unknown'} (ID: {user_id}) –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –∫–æ–º–∞–Ω–¥—É: {command}")
        
    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}")

def load_sticker_state():
    try:
        if not os.path.exists(STATE_FILE):
            return {}
        with open(STATE_FILE, "r", encoding="utf-8") as f:
            return json.load(f) or {}
    except Exception as e:
        logging.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å—Ç–∏–∫–µ—Ä–æ–≤: {e}")
        return {}

def save_sticker_state(state):
    try:
        with open(STATE_FILE, "w", encoding="utf-8") as f:
            json.dump(state, f, ensure_ascii=False, indent=2)
    except Exception as e:
        logging.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å—Ç–∏–∫–µ—Ä–æ–≤: {e}")

def choose_sticker_without_repeat(stickers, key):
    if not stickers:
        return None
    state = load_sticker_state()
    last = state.get(key)
    # –ò—Å–∫–ª—é—á–∞–µ–º –≤—á–µ—Ä–∞—à–Ω–∏–π, –µ—Å–ª–∏ –µ—Å—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞
    candidates = [s for s in stickers if s != last]
    if not candidates:
        candidates = stickers
    selected = choice(candidates)
    state[key] = selected
    save_sticker_state(state)
    return selected

if not BOT_TOKEN:
    raise ValueError("‚ùå BOT_TOKEN –Ω–µ —É–∫–∞–∑–∞–Ω –≤ .env")

bot = telebot.TeleBot(BOT_TOKEN)

with open("phrases.json", "r", encoding="utf-8") as f:
    PHRASES = json.load(f)

# –ü–∞—Ä—Å–∏–º –¥–∞—Ç—É
try:
    DEMILITARIZATION_DATE = date.fromisoformat(DEMILITARIZATION_DATE_STR)
except Exception as e:
    logging.error(f"–û—à–∏–±–∫–∞ –≤ –¥–∞—Ç–µ: {e}")
    DEMILITARIZATION_DATE = None

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∞–¥–º–∏–Ω–∞ –ø–æ user_id
def is_admin(user_id):
    return str(user_id) == str(ADMIN_USER_ID)

# –ö–æ–º–∞–Ω–¥–∞ /start ‚Äî –ø–æ–∫–∞–∂–µ—Ç user_id
@bot.message_handler(commands=['start'])
def send_welcome(message):
    # –õ–æ–≥–∏—Ä—É–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
    log_user_activity(
        message.from_user.id, 
        message.from_user.username, 
        "/start", 
        message.text
    )
    
    bot.reply_to(
        message,
        (
            "–ü—Ä–∏–≤–µ—Ç! üíï –Ø –±—É–¥—É –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å —Ç–µ–±—è –∫–∞–∂–¥—ã–π –¥–µ–Ω—å.\n"
            "–ö–æ–º–∞–Ω–¥—ã:\n"
            "/status ‚Äî —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –¥–æ –¥–µ–º–±–µ–ª—è\n"
            "/hug ‚Äî –ø–æ–ª—É—á–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É\n"
        ),
        parse_mode="Markdown"
    )

# /status ‚Äî –¥–ª—è –≤—Å–µ—Ö
@bot.message_handler(commands=['status'])
def send_status(message):
    # –õ–æ–≥–∏—Ä—É–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
    log_user_activity(
        message.from_user.id, 
        message.from_user.username, 
        "/status", 
        message.text
    )
    send_daily_update()

# /hug ‚Äî –¥–ª—è –≤—Å–µ—Ö
@bot.message_handler(commands=['hug'])
def send_hug(message):
    # –õ–æ–≥–∏—Ä—É–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
    log_user_activity(
        message.from_user.id, 
        message.from_user.username, 
        "/hug", 
        message.text
    )
    
    phrase = choice(PHRASES)
    bot.send_message(message.chat.id, f"ü§ó {phrase}")

# /send ‚Äî —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞
@bot.message_handler(commands=['send'])
def manual_send(message):
    if is_admin(message.from_user.id):
        send_daily_update()
        bot.reply_to(message, "‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤—Ä—É—á–Ω—É—é!")
    else:
        bot.reply_to(message, "üö´ –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç—É –∫–æ–º–∞–Ω–¥—É.")

# –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ ‚Äî —Ç–æ–ª—å–∫–æ —É–∫–∞–∑–∞–Ω–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
def send_daily_update():
    recipients = set()  # –∏—Å–ø–æ–ª—å–∑—É–µ–º set, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–µ–π, –µ—Å–ª–∏ ID —Å–æ–≤–ø–∞–¥–∞—é—Ç

    if USER_ID:
        recipients.add(str(USER_ID))
    if ADMIN_USER_ID:
        recipients.add(str(ADMIN_USER_ID))

    if not recipients:
        logging.error("–ù–∏ USER_ID, –Ω–∏ ADMIN_USER_ID –Ω–µ –∑–∞–¥–∞–Ω—ã")
        return

    if not DEMILITARIZATION_DATE:
        error_msg = "‚ùå –û—à–∏–±–∫–∞: –Ω–µ —É–∫–∞–∑–∞–Ω–∞ –¥–∞—Ç–∞ –¥–µ–º–±–µ–ª—è."
        for uid in recipients:
            try:
                bot.send_message(uid, error_msg)
            except Exception as e:
                logging.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∞–¥–º–∏–Ω—É/–ø–æ–ª—É—á–∞—Ç–µ–ª—é {uid}: {e}")
        return

    today = date.today()
    days_left = (DEMILITARIZATION_DATE - today).days

    if days_left < 0:
        msg = "üéâ –£–†–ê! –¢–≤–æ–π –ø–∞—Ä–µ–Ω—å —É–∂–µ –¥–µ–º–±–µ–ª—å! –ü–æ–∑–¥—Ä–∞–≤–ª—è—é! ü•≥"
    elif days_left == 0:
        msg = "–°–µ–≥–æ–¥–Ω—è –¥–µ–Ω—å –¥–µ–º–±–µ–ª—è! üéä –û–Ω —Å–≤–æ–±–æ–¥–µ–Ω! –ë–µ–≥–∏ –≤—Å—Ç—Ä–µ—á–∞—Ç—å! üíÉ"
    else:
        phrase = choice(PHRASES)
        msg = f"–î–æ –¥–µ–º–±–µ–ª—è —Ç–≤–æ–µ–≥–æ –ø–∞—Ä–Ω—è –æ—Å—Ç–∞–ª–æ—Å—å: *{days_left}* –¥–Ω–µ–π üíñ\n\n{phrase}"

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∂–¥–æ–º—É –ø–æ–ª—É—á–∞—Ç–µ–ª—é
    for uid in recipients:
        try:
            bot.send_message(uid, msg, parse_mode="Markdown")
        except Exception as e:
            logging.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {uid}: {e}")
    if not USER_ID:
        logging.error("USER_ID –Ω–µ –∑–∞–¥–∞–Ω")
        return

    if not DEMILITARIZATION_DATE:
        bot.send_message(USER_ID, "‚ùå –û—à–∏–±–∫–∞: –Ω–µ —É–∫–∞–∑–∞–Ω–∞ –¥–∞—Ç–∞ –¥–µ–º–±–µ–ª—è.")
        return

    today = date.today()
    days_left = (DEMILITARIZATION_DATE - today).days

    if days_left < 0:
        msg = "üéâ –£–†–ê! –¢–≤–æ–π –ø–∞—Ä–µ–Ω—å —É–∂–µ –¥–µ–º–±–µ–ª—å! –ü–æ–∑–¥—Ä–∞–≤–ª—è—é! ü•≥"
    elif days_left == 0:
        msg = "–°–µ–≥–æ–¥–Ω—è –¥–µ–Ω—å –¥–µ–º–±–µ–ª—è! üéä –û–Ω —Å–≤–æ–±–æ–¥–µ–Ω! –ë–µ–≥–∏ –≤—Å—Ç—Ä–µ—á–∞—Ç—å! üíÉ"
    else:
        phrase = choice(PHRASES)
        msg = f"–î–æ –¥–µ–º–±–µ–ª—è —Ç–≤–æ–µ–≥–æ –ø–∞—Ä–Ω—è –æ—Å—Ç–∞–ª–æ—Å—å: *{days_left}* –¥–Ω–µ–π üíñ\n\n{phrase}"

    try:
        bot.send_message(USER_ID, msg, parse_mode="Markdown")
    except Exception as e:
        logging.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {USER_ID}: {e}")

# –£—Ç—Ä–µ–Ω–Ω–µ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –≤ 07:00
def send_morning_greeting():
    recipients = set()

    if USER_ID:
        recipients.add(str(USER_ID))
    if ADMIN_USER_ID:
        recipients.add(str(ADMIN_USER_ID))

    if not recipients:
        logging.error("–ù–∏ USER_ID, –Ω–∏ ADMIN_USER_ID –Ω–µ –∑–∞–¥–∞–Ω—ã")
        return

    # –õ–æ–≥–∏—Ä—É–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –æ—Ç–ø—Ä–∞–≤–∫—É
    logging.info("üåÖ –û—Ç–ø—Ä–∞–≤–∫–∞ —É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è")
    
    text = "–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ! ‚òÄÔ∏è"
    for uid in recipients:
        try:
            bot.send_message(uid, text)
            sticker_id = choose_sticker_without_repeat(STICKERS, "morning")
            if sticker_id:
                bot.send_sticker(uid, sticker_id)
        except Exception as e:
            logging.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É—Ç—Ä–µ–Ω–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {uid}: {e}")

# –ù–æ—á–Ω–æ–µ –ø–æ–∂–µ–ª–∞–Ω–∏–µ –≤ 23:00
def send_night_greeting():
    recipients = set()

    if USER_ID:
        recipients.add(str(USER_ID))
    if ADMIN_USER_ID:
        recipients.add(str(ADMIN_USER_ID))

    if not recipients:
        logging.error("–ù–∏ USER_ID, –Ω–∏ ADMIN_USER_ID –Ω–µ –∑–∞–¥–∞–Ω—ã")
        return

    # –õ–æ–≥–∏—Ä—É–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –æ—Ç–ø—Ä–∞–≤–∫—É
    logging.info("üåô –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–æ—á–Ω–æ–≥–æ –ø–æ–∂–µ–ª–∞–Ω–∏—è")
    
    text = "–°–ª–∞–¥–∫–∏—Ö —Å–Ω–æ–≤! üåô"
    for uid in recipients:
        try:
            bot.send_message(uid, text)
            sticker_id = choose_sticker_without_repeat(STICKERS, "night")
            if sticker_id:
                bot.send_sticker(uid, sticker_id)
        except Exception as e:
            logging.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {uid}: {e}")

# –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫: –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 09:00 –ø–æ UTC+8
scheduler = BackgroundScheduler()
scheduler.add_job(
    send_daily_update,
    CronTrigger(hour=9, minute=0, timezone="Asia/Shanghai")
)
# –ù–æ–≤—ã–µ –∑–∞–¥–∞–Ω–∏—è: 07:00 ‚Äî –¥–æ–±—Ä–æ–µ —É—Ç—Ä–æ; 23:00 ‚Äî —Å–ª–∞–¥–∫–∏—Ö —Å–Ω–æ–≤
scheduler.add_job(
    send_morning_greeting,
    CronTrigger(hour=7, minute=00, timezone="Asia/Shanghai")
)
scheduler.add_job(
    send_night_greeting,
    CronTrigger(hour=23, minute=2, timezone="Asia/Shanghai")
)
scheduler.start()

# –ó–∞–ø—É—Å–∫
if __name__ == "__main__":
    logging.basicConfig(level=logging.INFO)
    logging.info("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω. –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ 09:00 (UTC+8) –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å USER_ID.")
    
    # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ —Å –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º
    def run_bot_safe():
        max_retries = 100
        retry_count = 0
        
        while retry_count < max_retries:
            try:
                logging.info(f"–ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è {retry_count + 1}/{max_retries}")
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API –¥–æ –∑–∞–ø—É—Å–∫–∞ long-polling
                me = bot.get_me()
                logging.info(f"‚úÖ –£—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Telegram API! –ë–æ—Ç: @{me.username} (id={me.id})")
                bot.polling(none_stop=True, skip_pending=True, timeout=20)
                break
            except Exception as e:
                retry_count += 1
                logging.error(f"–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (–ø–æ–ø—ã—Ç–∫–∞ {retry_count}): {e}")
                
                if retry_count < max_retries:
                    # –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ —Å –≤–µ—Ä—Ö–Ω–µ–π –≥—Ä–∞–Ω–∏—Ü–µ–π
                    wait_time = min(30, 5 * retry_count)
                    logging.info(f"–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ {wait_time} —Å–µ–∫—É–Ω–¥...")
                    time.sleep(wait_time)
                else:
                    logging.error("–ü—Ä–µ–≤—ã—à–µ–Ω–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è")
                    break
    
    try:
        run_bot_safe()
    except (KeyboardInterrupt, SystemExit):
        logging.info("–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞...")

        scheduler.shutdown()
